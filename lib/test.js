// Generated by CoffeeScript 1.6.3
(function() {
  var createKarmaFileList, fs, log, path, phantom, run, runBrowser, runKarma, runPhantom, utils;

  fs = require('fs');

  path = require('path');

  log = require('./log');

  utils = require('./utils');

  phantom = require('./phantom');

  run = function(apps, options) {
    var app, runTests, _i, _len, _results;
    switch (options.runner) {
      case "phantom":
        runTests = phantom.run ? runPhantom : runBrowser;
        break;
      case "karma":
        runTests = runKarma;
        break;
      case "browser":
        runTests = runBrowser;
        break;
      default:
        throw new Error("Invalid or unset test runner value: " + options.runner);
    }
    _results = [];
    for (_i = 0, _len = apps.length; _i < _len; _i++) {
      app = apps[_i];
      _results.push(runTests(app, options));
    }
    return _results;
  };

  runBrowser = function(app, options, done) {
    var open;
    open = require("open");
    return open(app.getTestPackage().getTestIndexFile());
  };

  runPhantom = function(app, options, done) {
    var testFile;
    log("Testing  application targets: <green>" + app.name + "</green>");
    testFile = app.getTestPackage().getTestIndexFile();
    options.output || (options.output = "passOrFail");
    return phantom.run(testFile, options, function(results) {
      if (options.singleRun) {
        return process.exit(results.fails);
      }
    });
  };

  runKarma = function(app, options) {
    var testConfig;
    if (options == null) {
      options = {};
    }
    testConfig = fs.existsSync(options.config) && fs.realpathSync(options.config);
    testConfig || (testConfig = {
      singleRun: options.singleRun || true,
      basePath: options.basePath,
      reporters: [options.output || 'progress'],
      logLevel: 'info',
      frameworks: [options.framework],
      browsers: options.browser && options.browser.split(/[ ,]+/) || ['PhantomJS'],
      files: createKarmaFileList(app)
    });
    return require('karma').server.start(testConfig);
  };

  createKarmaFileList = function(app) {};

  module.exports.run = run;

  module.exports.phantom = phantom;

}).call(this);
