// Generated by CoffeeScript 1.7.0
(function() {
  var CompileError, compileCoffeescript, compilers, cs, fs, lmCache, log, path, projectPath, requireLocalModule,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  fs = require('fs');

  path = require('path');

  log = require('./log');

  compilers = {};

  lmCache = {};

  compilers.argv = {};

  projectPath = path.resolve(process.cwd());

  requireLocalModule = function(localModule, _path) {
    var error, modulePath, relativePath;
    modulePath = "" + projectPath + "/node_modules/" + localModule;
    try {
      return lmCache[localModule] || (lmCache[localModule] = require(modulePath));
    } catch (_error) {
      error = _error;
      relativePath = path.relative(projectPath, _path);
      log.error("Unable to load <green>" + localModule + "</green> module to compile <yellow>" + relativePath + "</yellow>");
      log.error("Try to use 'npm install " + localModule + "' in your project directory.");
      if (log.VERBOSE) {
        log.error(error, false);
      }
      return process.exit();
    }
  };

  CompileError = (function(_super) {
    __extends(CompileError, _super);

    function CompileError(message, _path, ex) {
      CompileError.__super__.constructor.apply(this, arguments);
      this.name = "CompileError";
      this.path = _path;
      this.ex = ex;
    }

    return CompileError;

  })(Error);

  compilers.js = compilers.css = function(_path) {
    return fs.readFileSync(_path, 'utf8');
  };

  require.extensions['.css'] = function(module, filename) {
    var source;
    source = JSON.stringify(compilers.css(filename));
    return module._compile("module.exports = " + source, filename);
  };

  compilers.html = function(_path) {
    var content;
    content = fs.readFileSync(_path, 'utf8');
    return "module.exports = " + (JSON.stringify(content)) + ";\n";
  };

  require.extensions['.html'] = function(module, filename) {
    return module._compile(compilers.html(filename), filename);
  };

  require.extensions['.tmpl'] = function(module, filename) {
    return module._compile(compilers.html(filename), filename);
  };

  cs = require('coffee-script');

  compilers.coffee = function(_path) {
    return compileCoffeescript(_path);
  };

  compilers.litcoffee = function(_path) {
    return compileCoffeescript(_path, true);
  };

  compileCoffeescript = function(_path, literate) {
    var err;
    if (literate == null) {
      literate = false;
    }
    try {
      return cs.compile(fs.readFileSync(_path, 'utf8'), {
        filename: _path,
        literate: literate
      });
    } catch (_error) {
      err = _error;
      throw new CompileError("Coffeescript: " + ex.message, _path, err);
    }
  };

  compilers.hbs = function(_path) {
    var content, err, handlebars, source, template;
    handlebars = requireLocalModule('handlebars', _path);
    try {
      content = fs.readFileSync(path, 'utf8');
      template = handlebars.precompile(content, {
        separator: '\n',
        knownHelpers: [],
        knownHelpersOnly: false
      });
      source = template.toString();
      return "module.exports = Handlebars.template(" + source + ");";
    } catch (_error) {
      err = _error;
      throw new CompileError("handlebars: " + ex.message, _path, err);
    }
  };

  require.extensions['.hbs'] = function(module, filename) {
    return module._compile(compilers.hbs(filename), filename);
  };

  compilers.eco = function(_path) {
    var content, eco, err;
    eco = requireLocalModule('eco', _path);
    try {
      content = eco.precompile(fs.readFileSync(_path, 'utf8'));
      return "var content = " + content + ";\nmodule.exports = content;";
    } catch (_error) {
      err = _error;
      throw new CompileError("eco Error: " + ex.message, _path, err);
    }
  };

  compilers.jeco = function(_path) {
    var content, eco, err;
    eco = requireLocalModule('eco', _path);
    try {
      content = eco.precompile(fs.readFileSync(_path, 'utf8'));
      return "module.exports = function(values, data){\n  var $  = jQuery, result = $();\n  values = $.makeArray(values);\n  data = data || {};\n  for(var i=0; i < values.length; i++) {\n    var value = $.extend({}, values[i], data, {index: i});\n    var elem  = $((" + content + ")(value));\n    elem.data('item', value);\n    $.merge(result, elem);\n  }\n  return result;\n};";
    } catch (_error) {
      err = _error;
      throw new CompileError("jeco: " + err.message, _path, err);
    }
  };

  require.extensions['.jeco'] = require.extensions['.eco'];

  compilers.jade = function(_path) {
    var content, err, jCompile, jade, source, template;
    jade = requireLocalModule('jade', _path);
    content = fs.readFileSync(_path, 'utf8');
    try {
      jCompile = jade.compileClient || jade.compile;
      template = jCompile(content, {
        filename: _path,
        compileDebug: this.argv.command === "server",
        client: true
      });
      source = template.toString();
      return "module.exports = " + source + ";";
    } catch (_error) {
      err = _error;
      throw new CompileError("jade: " + err.message, _path, err);
    }
  };

  require.extensions['.jade'] = function(module, filename) {
    return module._compile(compilers.jade(filename), filename);
  };

  compilers.stylus = compilers.styl = function(_path) {
    var content, err, result, stylus;
    stylus = requireLocalModule('stylus', _path);
    try {
      content = fs.readFileSync(_path, 'utf8');
      result = '';
      stylus(content).include(path.dirname(_path)).render(function(err, css) {
        if (err) {
          throw err;
        }
        return result = css;
      });
      return result;
    } catch (_error) {
      err = _error;
      throw new CompileError("stylus: " + err.message, _path, err);
    }
  };

  require.extensions['.styl'] = function(module, filename) {
    var source;
    source = JSON.stringify(compilers.stylus(filename));
    return module._compile("module.exports = " + source, filename);
  };

  compilers.less = function(_path) {
    var content, less, result;
    less = requireLocalModule('less', _path);
    content = fs.readFileSync(_path, 'utf8');
    result = '';
    less.render(content, function(err, css) {
      if (err) {
        throw err;
      }
      return result = css;
    });
    return result;
  };

  require.extensions['.less'] = function(module, filename) {
    var source;
    source = JSON.stringify(compilers.less(filename));
    return module._compile("module.exports = " + source, filename);
  };

  compilers.env = function(_path) {
    var content, envhash, key, packjson;
    content = fs.readFileSync(_path, 'utf8');
    envhash = JSON.parse(content);
    packjson = JSON.parse(fs.readFileSync(path.join(projectPath, 'package.json'), 'utf8'));
    for (key in envhash) {
      if (packjson[key]) {
        envhash[key] = packjson[key];
      }
      if (process.env[key]) {
        envhash[key] = process.env[key];
      }
    }
    return "module.exports = " + JSON.stringify(envhash);
  };

  module.exports = compilers;

}).call(this);
